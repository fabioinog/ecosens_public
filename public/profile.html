<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Profile - EcoSENS</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }

        /* Loading Screen Styles */
        .loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--background);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            transition: opacity 0.5s ease-out;
        }

        .loading-screen.hidden {
            opacity: 0;
            pointer-events: none;
        }

        .loading-logo {
            width: 120px;
            height: 120px;
            animation: rotate 2s linear infinite;
        }

        @keyframes rotate {
            from {
                transform: rotate(0deg);
            }
            to {
                transform: rotate(360deg);
            }
        }

        .main-content {
            opacity: 0;
            transition: opacity 0.5s ease-in;
        }

        .main-content.loaded {
            opacity: 1;
        }
        :root {
            /* Green Theme Color Palette */
            --primary-green: #22c55e;
            --primary-green-dark: #16a34a;
            --primary-green-light: #4ade80;
            --secondary-green: #166534;
            --accent-green: #15803d;
            --light-green: #f0fdf4;
            --medium-green: #bbf7d0;
            
            /* Neutral Colors with Green Tints */
            --white: #ffffff;
            --background: #f0fdf4;
            --surface: #ffffff;
            --border: #bbf7d0;
            --text-primary: #14532d;
            --text-secondary: #365d3e;
            --text-inverse: #ffffff;
        }

        body { font-family: 'Segoe UI', system-ui, -apple-system, sans-serif; background: var(--background); color: var(--text-primary); line-height: 1.6; }
        .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
        
        .topbar { background: var(--surface); border-radius: 16px; box-shadow: 0 8px 25px rgba(34, 197, 94, 0.15); padding: 20px; margin: 20px 0; display: flex; align-items: center; justify-content: space-between; border: 1px solid var(--border); }
        .brand { font-weight: 800; font-size: 24px; color: var(--text-primary); display: flex; align-items: center; gap: 12px; }
        .brand-logo { width: 32px; height: 32px; object-fit: contain; }
        .nav { display: flex; gap: 8px; }
        .tab { background: var(--light-green); border: 1px solid var(--border); color: var(--text-secondary); padding: 12px 20px; border-radius: 12px; cursor: pointer; font-weight: 600; text-decoration: none; transition: all 0.3s ease; font-size: 14px; }
        .tab:hover { background: var(--medium-green); color: var(--text-primary); transform: translateY(-2px); }
        .tab.active { background: var(--primary-green); color: var(--text-inverse); border-color: var(--primary-green-dark); box-shadow: 0 4px 12px rgba(34, 197, 94, 0.3); }
        .actions { display: flex; gap: 8px; }
        .btn { background: var(--primary-green); color: var(--text-inverse); border: none; padding: 14px 28px; border-radius: 12px; font-weight: 600; cursor: pointer; font-size: 14px; transition: all 0.3s ease; box-shadow: 0 2px 8px rgba(34, 197, 94, 0.2); }
        .btn:hover { background: var(--primary-green-dark); transform: translateY(-2px); box-shadow: 0 4px 15px rgba(34, 197, 94, 0.3); }
        .btn.secondary { background: var(--surface); color: var(--text-primary); border: 2px solid var(--border); }
        .btn.secondary:hover { background: var(--light-green); border-color: var(--primary-green); }
        .card { background: var(--surface); border-radius: 16px; padding: 28px; box-shadow: 0 8px 25px rgba(34, 197, 94, 0.1); margin-bottom: 28px; border: 1px solid var(--border); transition: all 0.3s ease; }
        .card:hover { box-shadow: 0 12px 35px rgba(34, 197, 94, 0.15); transform: translateY(-2px); }
        h1 { font-size: 32px; font-weight: 800; color: var(--text-primary); margin-bottom: 28px; }
        h2 { font-size: 24px; font-weight: 700; margin-bottom: 20px; color: var(--text-primary); }
        h3 { font-size: 20px; font-weight: 700; margin-bottom: 16px; color: var(--text-primary); }
        
        .form-field { display: flex; flex-direction: column; }
        .label { font-weight: 600; font-size: 14px; margin-bottom: 8px; color: var(--text-secondary); }
        .input { width: 100%; padding: 12px 16px; background: var(--surface); border: 2px solid var(--border); font-size: 14px; border-radius: 12px; color: var(--text-primary); transition: all 0.3s ease; }
        .select { width: 100%; padding: 12px 16px; background: var(--surface); border: 2px solid var(--border); font-size: 14px; border-radius: 12px; color: var(--text-primary); transition: all 0.3s ease; }
        .input:focus { background: var(--surface); border-color: var(--primary-green); outline: none; box-shadow: 0 0 0 3px rgba(34, 197, 94, 0.1); }
        .select:focus { background: var(--surface); border-color: var(--primary-green); outline: none; box-shadow: 0 0 0 3px rgba(34, 197, 94, 0.1); }
		
		.submit-buttons { display: flex; gap: 8px; margin-bottom: 24px; }
		.submit-buttons button, .submit-buttons a { flex: 1; text-align: center; }
		.btn-submit { background: var(--primary-green); color: var(--text-inverse); border: none; padding: 14px 28px; border-radius: 12px; cursor: pointer; font-weight: 600; font-size: 14px; transition: all 0.3s ease; box-shadow: 0 2px 8px rgba(34, 197, 94, 0.2); text-decoration: none; display: inline-block; }
		.btn-submit:hover { background: var(--primary-green-dark); transform: translateY(-2px); box-shadow: 0 4px 15px rgba(34, 197, 94, 0.3); }
		.btn-submit.secondary { background: var(--surface); color: var(--text-primary); border: 2px solid var(--border); }
		.btn-submit.secondary:hover { background: var(--light-green); border-color: var(--primary-green); }
    </style>
    <script>
        // Wait for DOM to load before adding event listeners
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('logoutBtn').addEventListener('click', async () => {
                try {
                    const res = await fetch('/api/logout', { method: 'POST' });
                    if (res.ok) {
                        window.location.href = '/login';
                    }
                } catch (e) { 
                    console.error('Logout failed', e); 
                    window.location.href = '/login';
                }
            });
        });
        
        function updateAccountDetails(data, username) {
            // Update username
            document.getElementById('userDetails-username').textContent = username || 'Unknown';
            
            // Update real name (handle NULL, undefined, empty string, and whitespace)
            const realName = data.realName && data.realName.trim && data.realName.trim() !== '' ? data.realName.trim() : 'Not provided';
            document.getElementById('userDetails-realName').textContent = realName;
            
            // Update farm size (handle NULL, undefined, empty string, and whitespace)
            const farmSize = data.farmSize && data.farmSize.toString().trim && data.farmSize.toString().trim() !== '' ? `${data.farmSize} acres` : 'Not provided';
            document.getElementById('userDetails-farmSize').textContent = farmSize;


            // Update country/location (handle NULL, undefined, empty string, and whitespace)
            const country = data.country && data.country.trim && data.country.trim() !== '' ? data.country.trim() : 'Not set';
            document.getElementById('userDetails-country').textContent = country;
            
            console.log('Account details updated:', { username, realName, farmSize, country });
            console.log('Raw data received:', data);
        }
        async function loadProfile() {
            try {
                console.log('Loading profile and user data...');
                
                // Get profile data
                const profileRes = await fetch('/api/profile');
                console.log('Profile response status:', profileRes.status);
                if (!profileRes.ok) {
                    console.error('Profile response not OK:', profileRes.status);
                    return;
                }
                const profileData = await profileRes.json();
                console.log('Profile data received:', profileData);
                
                // Get user data for username
                const userRes = await fetch('/api/user');
                console.log('User response status:', userRes.status);
                let username = 'Unknown';
                if (userRes.ok) {
                    const userData = await userRes.json();
                    username = userData.username || 'Unknown';
                    console.log('Username received:', username);
                }
                
                // Update form fields (handle NULL properly)
                document.getElementById('realName').value = profileData.realName || '';
                document.getElementById('farmSize').value = profileData.farmSize || '';
                document.getElementById('country').value = profileData.country || '';
                
                // Debug: log form field values
                console.log('Form fields set:');
                console.log('  Real name field:', document.getElementById('realName').value);
                console.log('  Farm size field:', document.getElementById('farmSize').value);
                console.log('  Country field:', document.getElementById('country').value);
                
                // Update account details display
                updateAccountDetails(profileData, username);
                console.log('Profile loaded and account details updated');
            } catch (e) { 
                console.error('Error loading profile:', e); 
            }
        }
        async function saveProfile() {
            const data = {
                realName: document.getElementById('realName').value.trim(),
                farmSize: document.getElementById('farmSize').value,
                country: document.getElementById('country').value
            };
            
            console.log('Saving profile data:', data);
            
            try {
                const res = await fetch('/api/profile', {
                    method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(data)
                });
                
                console.log('Save response status:', res.status);
                
                if (res.ok) { 
                    console.log('Profile saved successfully, updating account details');
                    
                    // Reload profile data and update account details
                    await loadProfile();
                    
                    alert('Profile saved successfully!'); 
                    
                    // If country was set, redirect to dashboard
                    if (data.country) {
                        console.log('Country set, redirecting to dashboard in 1 second');
                        setTimeout(() => {
                            window.location.href = '/my-farm';
                        }, 1000);
                    }
                } else {
                    const errorData = await res.json();
                    console.error('Error response from server:', errorData);
                    alert('Error saving profile: ' + (errorData.error || 'Unknown error'));
                }
            } catch (e) { 
                console.error('Network error saving profile:', e); 
                alert('Network error saving profile. Please try again.');
            }
        }
        
        // Check if this is a new user
        function checkNewUser() {
            const urlParams = new URLSearchParams(window.location.search);
            const isNewUser = urlParams.get('new') === 'true';
            
            if (isNewUser) {
                // Show the warning notice
                document.getElementById('newUserNotice').style.display = 'block';
                
                // Highlight the country field
                document.getElementById('requiredIndicator').style.display = 'inline';
                document.getElementById('country').style.borderColor = '#dc3545';
                document.getElementById('country').style.backgroundColor = '#fff5f5';
                
                console.log('New user detected - highlighting country field as required');
            }
        }
        
        window.addEventListener('DOMContentLoaded', async () => {
            console.log('Page loaded, starting profile initialization');
            
            // Check authentication first
            try {
                const authCheck = await fetch('/api/user');
                if (!authCheck.ok) {
                    console.log('Not authenticated, redirecting to login');
                    window.location.href = '/login';
                    return;
                }
                console.log('Authentication confirmed, loading profile');
            } catch (e) {
                console.error('Auth check failed:', e);
                window.location.href = '/login';
                return;
            }
            
            await loadProfile();
            checkNewUser();
        });
    </script>
</head>
<body>
    <!-- Loading Screen -->
    <div class="loading-screen" id="loadingScreen">
        <img src="/logo.png" alt="EcoSENS Logo" class="loading-logo">
    </div>

    <!-- Main Content -->
    <div class="main-content" id="mainContent">
    <div class="container">
        <div class="topbar">
            <div class="brand">
                <img src="/logo.png" alt="EcoSENS Logo" class="brand-logo">
                EcoSENS
            </div>
            <div class="nav">
                <a href="/my-farm" class="tab">My Farm</a>
                <a href="/feed" class="tab">Feed</a>
                <a href="/profile" class="tab active">Profile</a>
            </div>
            <div class="actions">
                <button class="btn" id="logoutBtn">Logout</button>
            </div>
        </div>

        <div class="card">
            <h3>Your Profile</h3>
            
            <div id="newUserNotice" style="background: #ffe6e6; border: 1px solid #ff6b6b; border-radius: 8px; padding: 20px; margin-bottom: 24px; display: none;">
                <div style="display: flex; align-items: center; margin-bottom: 12px;">
                    <span style="font-size: 24px; margin-right: 12px;">!</span>
                    <h3 style="color: #d63384; margin: 0; font-weight: 700;">Account Setup Required</h3>
                </div>
                <div style="color: #721c24; line-height: 1.6;">
                    <p style="margin: 0 0 8px 0; font-weight: 600;">You CANNOT navigate the website until you complete your profile!</p>
                    <p style="margin: 0 0 8px 0;"><strong>Required:</strong> Select a country/location from the dropdown below</p>
                    <p style="margin: 0; font-size: 14px;">Once you select a country, you will be redirected to your dashboard and can access all features.</p>
                </div>
            </div>
            <div class="form-field">
                <label for="realName">Real Name</label>
                <input type="text" id="realName" placeholder="e.g., Jane Doe" />
            </div>
            <div class="form-field">
                <label for="farmSize">Farm Size (acres)</label>
                <input type="number" id="farmSize" min="0" step="0.1" placeholder="e.g., 25" />
            </div>
            <div class="form-field" id="countryFieldContainer">
                <label for="country">Location (Country) <span id="requiredIndicator" style="color: #dc3545; font-weight: bold; display: none;">* REQUIRED</span></label>
                <select id="country" style="border: 2px solid #ddd;">
                    <option value="">Select a country</option>
                    <option>United States</option>
                    <option>Canada</option>
                    <option>United Kingdom</option>
                    <option>Australia</option>
                    <option>India</option>
                    <option>Nigeria</option>
                    <option>Kenya</option>
                    <option>Brazil</option>
                    <option>Mexico</option>
                    <option>Philippines</option>
                    <option>South Africa</option>
                    <option>Germany</option>
                    <option>France</option>
                    <option>Spain</option>
                    <option>Italy</option>
                    <option>China</option>
                    <option>Japan</option>
                    <option>Indonesia</option>
                    <option>Turkey</option>
                    <option>Argentina</option>
                </select>
            </div>
            
            <!-- Add separation between location selection and save button -->
            <div style="height: 24px;"></div>
            
            <div class="submit-buttons" style="display: block;">
                <button class="btn-submit" onclick="saveProfile()" style="width: 100%; text-align: center;">Save Profile</button>
            </div>
        </div>

        <div class="card" style="margin-top:16px;">
            <h3>Account Details</h3>
            <div style="margin-top:12px;">
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                    <div>
                        <label style="font-weight: 600; color: #2c3e50;">Username:</label>
                        <div id="userDetails-username" style="color: #444; margin-top: 4px;">Loading...</div>
                    </div>
                    <div>
                        <label style="font-weight: 600; color: #2c3e50;">Real Name:</label>
                        <div id="userDetails-realName" style="color: #444; margin-top: 4px;">Not provided</div>
                    </div>
                    <div>
                        <label style="font-weight: 600; color: #2c3e50;">Farm Size:</label>
                        <div id="userDetails-farmSize" style="color: #444; margin-top: 4px;">Not provided</div>
                    </div>
                    <div>
                        <label style="font-weight: 600; color: #2c3e50;">Location:</label>
                        <div id="userDetails-country" style="color: #444; margin-top: 4px;">Not set</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    </div>

    <script>
        // Loading Screen Management for Profile
        window.addEventListener('load', function() {
            // Only show loading screen after login/signup
            const showLoadingScreen = sessionStorage.getItem('showLoadingScreen');
            if (showLoadingScreen === 'true') {
                // Clear the flag so it doesn't show on subsequent pages
                sessionStorage.removeItem('showLoadingScreen');
                
                // Show loading screen
                const loadingScreen = document.getElementById('loadingScreen');
                const mainContent = document.getElementById('mainContent');
                
                loadingScreen.style.display = 'flex';
                
                setTimeout(() => {
                    loadingScreen.classList.add('hidden');
                    mainContent.classList.add('loaded');
                    
                    // Remove loading screen from DOM after fade out
                    setTimeout(() => {
                        loadingScreen.style.display = 'none';
                    }, 500);
                }, 1000);
            } else {
                // Keep loading screen hidden for normal page navigation
                const mainContent = document.getElementById('mainContent');
                mainContent.classList.add('loaded');
            }
        });
    </script>
</body>
</html>