<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Pest Trap Submissions - EcoSENS</title>
	<style>
		:root {
			/* Green Theme Color Palette */
			--primary-green: #22c55e;
			--primary-green-dark: #16a34a;
			--primary-green-light: #4ade80;
			--secondary-green: #166534;
			--accent-green: #15803e;
			--light-green: #f0fdf4;
			--medium-green: #bbf7d0;
			
			/* Neutral Colors with Green Tints */
			--white: #ffffff;
			--background: #f0fdf4;
			--surface: #ffffff;
			--border: #bbf7d0;
			--text-primary: #14532d;
			--text-secondary: #365d3e;
			--text-inverse: #ffffff;
		}

		* { box-sizing: border-box; margin: 0; padding: 0; }
		body { font-family: 'Segoe UI', system-ui, -apple-system, sans-serif; background: var(--background); color: var(--text-primary); }
		.container { max-width: 1200px; margin: 0 auto; padding: 20px; }

		/* Top Navigation */
		.topbar { background: var(--surface); border-radius: 16px; box-shadow: 0 8px 25px rgba(34, 197, 94, 0.15); padding: 20px; margin: 20px 0; display: flex; align-items: center; justify-content: space-between; border: 1px solid var(--border); }
		.brand { font-weight: 800; font-size: 24px; color: var(--text-primary); display: flex; align-items: center; gap: 12px; }
		.brand-logo { width: 32px; height: 32px; object-fit: contain; }
		.nav { display: flex; gap: 8px; }
		.tab { background: var(--light-green); border: 1px solid var(--border); color: var(--text-secondary); padding: 12px 20px; border-radius: 12px; cursor: pointer; font-weight: 600; text-decoration: none; transition: all 0.3s ease; font-size: 14px; }
		.tab:hover { background: var(--medium-green); color: var(--text-primary); transform: translateY(-2px); }
		.tab.active { background: var(--primary-green); color: var(--text-inverse); border-color: var(--primary-green-dark); box-shadow: 0 4px 12px rgba(34, 197, 94, 0.3); }
		.actions { display: flex; gap: 8px; }
		.btn { background: var(--primary-green); color: var(--text-inverse); border: none; padding: 14px 28px; border-radius: 12px; font-weight: 600; cursor: pointer; font-size: 14px; transition: all 0.3s ease; box-shadow: 0 2px 8px rgba(34, 197, 94, 0.2); }
		.btn:hover { background: var(--primary-green-dark); transform: translateY(-2px); box-shadow: 0 4px 15px rgba(34, 197, 94, 0.3); }
		.btn.secondary { background: var(--surface); color: var(--text-primary); border: 2px solid var(--border); }
		.btn.secondary:hover { background: var(--light-green); border-color: var(--primary-green); }

		/* Main Content */
		.main-card { background: var(--surface); border-radius: 16px; padding: 28px; box-shadow: 0 8px 25px rgba(34, 197, 94, 0.1); margin-bottom: 28px; border: 1px solid var(--border); transition: all 0.3s ease; }
		.main-card:hover { box-shadow: 0 12px 35px rgba(34, 197, 94, 0.15); transform: translateY(-2px); }
		.title { font-size: 32px; font-weight: 800; color: var(--text-primary); margin-bottom: 24px; }

		/* Settings Row */
		.settings-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding: 16px; background: #f8f9fa; border-radius: 8px; }
		.area-selector { display: flex; align-items: center; gap: 12px; }
		.filter-label { font-weight: 600; color: #2c3e50; }
		.btn-filter { background: #2196F3; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-weight: 600; }

		/* Table */
		.submissions-table { width: 100%; border-collapse: collapse; border: 1px solid #e0e0e0; background: white; border-radius: 8px; overflow: hidden; }
		.submissions-table th { background: #f8f9fa; color: #2c3e50; padding: 12px 16px; text-align: left; font-weight: 700; border-bottom: 2px solid #e0e0e0; }
		.submissions-table td { padding: 12px 16px; border-bottom: 1px solid #f0f0f0; }
		.submissions-table tr:hover { background: #f8f9fa; }
		.pest-badge { padding: 4px 12px; border-radius: 20px; font-weight: 600; font-size: 12px; text-transform: uppercase; }
		.pest-very-low { background: #e8f5e8; color: #2e7d32; }
		.pest-low { background: #e3f2fd; color: #1976d2; }
		.pest-moderate { background: #fff3e0; color: #f57c00; }
		.pest-high { background: #ffebee; color: #d32f2f; }
		.pest-very-high { background: #f3e5f5; color: #7b1fa2; }
		
		.view-link { color: #2196F3; text-decoration: none; font-weight: 600; }
		.view-link:hover { text-decoration: underline; }

		/* Loading and Empty States */
		.loading { text-align: center; padding: 40px; color: #666; }
		.empty-state { text-align: center; padding: 40px; color: #666; }
		.refresh-btn { background: var(--primary-green); color: var(--text-inverse); border: none; padding: 12px 20px; border-radius: 12px; cursor: pointer; font-weight: 600; margin-top: 16px; transition: all 0.3s ease; }
		.refresh-btn:hover { background: var(--primary-green-dark); transform: translateY(-2px); }

		.submit-buttons { display: flex; gap: 8px; margin-bottom: 24px; }
		.submit-buttons button, .submit-buttons a { flex: 1; text-align: center; }
		.btn-submit { background: var(--primary-green); color: var(--text-inverse); border: none; padding: 14px 28px; border-radius: 12px; cursor: pointer; font-weight: 600; font-size: 14px; transition: all 0.3s ease; box-shadow: 0 2px 8px rgba(34, 197, 94, 0.2); text-decoration: none; display: inline-block; }
		.btn-submit:hover { background: var(--primary-green-dark); transform: translateY(-2px); box-shadow: 0 4px 15px rgba(34, 197, 94, 0.3); }
		.btn-submit.secondary { background: var(--surface); color: var(--text-primary); border: 2px solid var(--border); }
		.btn-submit.secondary:hover { background: var(--light-green); border-color: var(--primary-green); }

		@media (max-width: 768px) { 
			.container { padding: 12px; }
			.topbar { flex-direction: column; gap: 12px; }
			.settings-row { flex-direction: column; gap: 12px; align-items: stretch; }
			.submissions-table { font-size: 14px; }
			.submissions-table th, .submissions-table td { padding: 8px 12px; }
		}
	</style>
</head>
<body>
	<div class="container">
		<div class="topbar">
			<div class="brand">
				<img src="/logo.png" alt="EcoSENS Logo" class="brand-logo">
				EcoSENS
			</div>
			<div class="nav">
				<a href="/my-farm" class="tab">My Farm</a>
				<a href="/feed" class="tab">Feed</a>
				<a href="/profile" class="tab">Profile</a>
			</div>
			<div class="actions">
				<button class="btn" id="logoutBtn">Logout</button>
			</div>
		</div>

		<div class="main-card">
			<h1 class="title">Pest Trap Analysis Submissions</h1>
			
			<div class="submit-buttons">
				<button class="btn-submit secondary" id="refreshData">Get Updated Submissions</button>
				<a href="/my-farm" class="btn-submit secondary" style="text-decoration: none;">Back to My Farm</a>
			</div>
			
			<div class="settings-row">
				<div class="area-selector">
					<span class="filter-label">Area:</span>
					<select id="areaFilter">
						<option value="">All Areas</option>
					</select>
					<button class="btn-filter" id="applyFilter">Apply Filter</button>
				</div>
				<button class="refresh-btn" id="refreshData">Refresh Data</button>
			</div>
			<div id="userAreaInfo" style="margin-top: 8px; font-size: 12px; color: #666;"></div>

			<table class="submissions-table" id="submissionsTable">
				<thead>
					<tr>
						<th>ID</th>
						<th>Area</th>
						<th>Pest Amount</th>
						<th>Image</th>
						<th>Sample Date</th>
					</tr>
				</thead>
				<tbody>
					<tr>
						<td colspan="5" class="loading">Loading submissions...</td>
					</tr>
				</tbody>
			</table>
		</div>
	</div>

	<script>
		// Navigation
		document.getElementById('logoutBtn').addEventListener('click', async () => {
			try {
				const res = await fetch('/api/logout', { method: 'POST' });
				if (res.ok) {
					window.location.href = '/login';
				}
			} catch (e) { 
				console.error('Logout failed', e); 
				window.location.href = '/login';
			}
		});

		// Apply Area Filter
		document.getElementById('applyFilter').addEventListener('click', () => {
			loadSubmissions();
		});

		// Refresh Data
		document.getElementById('refreshData').addEventListener('click', () => {
			loadSubmissions();
		});

		// Load user area info and populate filter options
		async function loadUserAreaInfo() {
			try {
				// Load user profile to get current area
				const profileRes = await fetch('/api/profile');
				const profileData = await profileRes.json();
				const userArea = profileData.country || 'Unknown Location';
				
				// Update UI to show current area
				const areaInfoDiv = document.getElementById('userAreaInfo');
				areaInfoDiv.textContent = `Current analysis area: ${userArea}`;
				
				// Load submissions to get all available areas
				const submissionsRes = await fetch('/api/submissions?limit=1000');
				const submissionsData = await submissionsRes.json();
				
				if (submissionsData.success) {
					// Get unique areas from submissions
					const uniqueAreas = [...new Set(submissionsData.submissions.map(sub => sub.area_id))];
					const areaFilter = document.getElementById('areaFilter');
					
					// Clear existing options except "All Areas"
					areaFilter.innerHTML = '<option value="">All Areas</option>';
					
					// Add unique areas to filter
					uniqueAreas.forEach(area => {
						const option = document.createElement('option');
						option.value = area;
						option.textContent = area;
						if (area === userArea) option.selected = true; // Select current area by default
						areaFilter.appendChild(option);
					});
				}
				
			} catch (error) {
				console.error('Error loading user area info:', error);
				const areaInfoDiv = document.getElementById('userAreaInfo');
				areaInfoDiv.textContent = 'Current analysis area: Unknown Location';
			}
		}
		
		function getPestBadgeClass(pestAmount) {
			switch (pestAmount.toLowerCase()) {
				case 'very low': return 'pest-very-low';
				case 'low': return 'pest-low';
				case 'moderate': return 'pest-moderate';
				case 'high': return 'pest-high';
				case 'very high': return 'pest-very-high';
				default: return 'pest-low';
			}
		}

		async function loadSubmissions() {
			const tableBody = document.querySelector('#submissionsTable tbody');
			const areaFilter = document.getElementById('areaFilter').value;
			
			// Show loading state
			tableBody.innerHTML = '<tr><td colspan="5" class="loading">Loading submissions...</td></tr>';
			
			try {
				const url = areaFilter ? `/api/submissions?areaId=${encodeURIComponent(areaFilter)}&limit=50` : '/api/submissions?limit=50';
				const res = await fetch(url);
				const data = await res.json();
				
				if (data.success && data.submissions.length > 0) {
					tableBody.innerHTML = '';
					data.submissions.forEach(sub => {
						const row = document.createElement('tr');
						row.innerHTML = `
							<td>#${sub.id}</td>
							<td>${sub.area_id}</td>
							<td><span class="pest-badge ${getPestBadgeClass(sub.pest_amount)}">${sub.pest_amount}</span></td>
							<td><a href="${sub.file_url}" target="_blank" class="view-link">View Image</a></td>
							<td>${sub.created_at ? new Date(sub.created_at).toLocaleDateString() : 'N/A'}</td>
						`;
						tableBody.appendChild(row);
					});
				} else {
					tableBody.innerHTML = '<tr><td colspan="5" class="empty-state">No submissions found</td></tr>';
				}
			} catch (error) {
				console.error('Error loading submissions:', error);
				tableBody.innerHTML = '<tr><td colspan="5" class="empty-state">Failed to load submissions. Please try again.</td></tr>';
			}
		}

		// Load user area info and submissions on page load
		loadUserAreaInfo();
		
		// Wait for area info to load, then load submissions
		setTimeout(() => {
			loadSubmissions();
		}, 500);

		// Auto-refresh every 30 seconds
		setInterval(() => {
			loadUserAreaInfo();
			loadSubmissions();
		}, 30000);
	</script>
</body>
</html>
